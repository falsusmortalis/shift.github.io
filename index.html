<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—Ä—è–¥–æ–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #f0f2f5;
            padding: 15px;
            color: #333;
        }
        
        .container {
            max-width: 100%;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 22px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: #ecf0f1;
            border-radius: 8px;
            padding: 4px;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: none;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 10px;
        }
        
        button:hover {
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .employee-item {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #3498db;
        }
        
        .result-item {
            background: #d5f4e6;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #27ae60;
        }
        
        .error-item {
            background: #fdeaea;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #e74c3c;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-range input {
            flex: 1;
        }
        
        .date-range span {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 12px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
            min-width: 35px;
        }
        
        th {
            background: #34495e;
            color: white;
            font-weight: 600;
        }
        
        .employee-cell {
            text-align: left;
            font-weight: 600;
            background: #ecf0f1;
            position: sticky;
            left: 0;
            min-width: 100px;
        }
        
        .vacation-cell {
            background: #f39c12;
            color: white;
            font-weight: bold;
        }
        
        .shift-cell {
            background: #27ae60;
            color: white;
            font-weight: bold;
        }
        
        .rest-cell {
            background: #f1c40f;
            color: #2c3e50;
        }
        
        .unassigned-cell {
            background: #e74c3c;
            color: white;
            font-weight: bold;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-card {
            background: #ecf0f1;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—Ä—è–¥–æ–≤</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('employees')">üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</button>
            <button class="tab" onclick="showTab('schedule')">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
            <button class="tab" onclick="showTab('results')">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ -->
        <div id="employees-tab" class="tab-content active">
            <div class="input-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:</label>
                <input type="number" id="employeeCount" min="1" max="20" value="3" onchange="updateEmployeeFields()">
            </div>
            
            <div id="employeeFields"></div>
            
            <button onclick="saveEmployees()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</button>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è -->
        <div id="schedule-tab" class="tab-content">
            <div class="input-group">
                <label>–í–≤–µ–¥–∏—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (CSV —Ñ–æ—Ä–º–∞—Ç):</label>
                <textarea id="manualSchedule" rows="8" placeholder="–¥–∞—Ç–∞;–Ω–∞—Ä—è–¥—ã&#10;01.10.2025;1,2,3&#10;02.10.2025;1,2">01.10.2025;1,2,3
02.10.2025;1,2
03.10.2025;1,2,3
04.10.2025;1,2
05.10.2025;1,2,3
06.10.2025;1,2
07.10.2025;1,2,3
08.10.2025;1,2
09.10.2025;1,2,3
10.10.2025;1,2</textarea>
            </div>
            
            <button onclick="parseSchedule()">üìã –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div id="results-tab" class="tab-content">
            <div id="loading" class="loading hidden">
                <div class="spinner"></div>
                <p>–†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—Ä—è–¥—ã...</p>
            </div>
            
            <div class="input-group">
                <label>–§–æ—Ä–º–∞—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
                <select id="viewType" onchange="changeView()">
                    <option value="stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</option>
                    <option value="table">–¢–∞–±–ª–∏—Ü–∞</option>
                    <option value="unassigned">–ù–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ</option>
                </select>
            </div>
            
            <div id="statsView">
                <div id="resultsContainer">
                    <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ</p>
                </div>
            </div>
            
            <div id="tableView" class="hidden">
                <div style="overflow-x: auto;">
                    <table id="calendarTable"></table>
                </div>
            </div>
            
            <div id="unassignedView" class="hidden">
                <div id="unassignedContainer"></div>
            </div>
            
            <button onclick="generateSchedule()" id="generateBtn">üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
        </div>
    </div>

    <script>
        // Telegram Web App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        let tg = window.Telegram?.WebApp;
        if (tg) {
            tg.expand();
            tg.ready();
        }
        
        // –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let appData = {
            employees: [],
            schedule: {},
            results: null
        };
        
        // –ü–æ–∫–∞–∑ –≤–∫–ª–∞–¥–æ–∫
        function showTab(tabName) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É
            event.target.classList.add('active');
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        function updateEmployeeFields() {
            const count = parseInt(document.getElementById('employeeCount').value);
            const container = document.getElementById('employeeFields');
            container.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const employeeHtml = `
                    <div class="employee-item">
                        <h3>–°–æ—Ç—Ä—É–¥–Ω–∏–∫ ${i + 1}</h3>
                        <div class="input-group">
                            <label>–§–∞–º–∏–ª–∏—è:</label>
                            <input type="text" id="empName${i}" placeholder="–ò–≤–∞–Ω–æ–≤" value="–°–æ—Ç—Ä—É–¥–Ω–∏–∫ ${i + 1}">
                        </div>
                        <div class="input-group">
                            <label>–û—Ç–ø—É—Å–∫ (–ø–µ—Ä–∏–æ–¥):</label>
                            <div class="date-range">
                                <input type="text" id="vacStart${i}" placeholder="01.10.2025">
                                <span>–ø–æ</span>
                                <input type="text" id="vacEnd${i}" placeholder="05.10.2025">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (0-10):</label>
                            <input type="number" id="priority${i}" min="0" max="10" value="0">
                        </div>
                    </div>
                `;
                container.innerHTML += employeeHtml;
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        function saveEmployees() {
            const count = parseInt(document.getElementById('employeeCount').value);
            appData.employees = [];
            
            for (let i = 0; i < count; i++) {
                const name = document.getElementById('empName' + i)?.value.trim();
                if (name) {
                    const start = document.getElementById('vacStart' + i)?.value.trim();
                    const end = document.getElementById('vacEnd' + i)?.value.trim();
                    const priority = parseInt(document.getElementById('priority' + i)?.value) || 0;
                    
                    let vacationDays = [];
                    if (start && end) {
                        vacationDays = getDateRange(start, end);
                    }
                    
                    appData.employees.push({
                        name: name,
                        vacationDays: vacationDays,
                        priority: priority
                    });
                }
            }
            
            if (appData.employees.length > 0) {
                alert('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ' + appData.employees.length + ' —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤');
                showTab('schedule');
            } else {
                alert('‚ùå –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
            }
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç
        function getDateRange(startStr, endStr) {
            const start = parseDate(startStr);
            const end = parseDate(endStr);
            if (!start || !end) return [];
            
            const dates = [];
            const current = new Date(start);
            
            while (current <= end) {
                dates.push(formatDate(current));
                current.setDate(current.getDate() + 1);
            }
            
            return dates;
        }
        
        // –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã
        function parseDate(str) {
            const parts = str.split('.');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                const year = parseInt(parts[2]);
                return new Date(year, month, day);
            }
            return null;
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }
        
        // –ü–∞—Ä—Å–∏–Ω–≥ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        function parseSchedule() {
            const text = document.getElementById('manualSchedule').value;
            if (!text.trim()) {
                alert('‚ùå –í–≤–µ–¥–∏—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ');
                return;
            }
            
            appData.schedule = {};
            const lines = text.split('\n');
            let days = 0, shifts = 0;
            
            for (let line of lines) {
                line = line.trim();
                if (!line || line.startsWith('–¥–∞—Ç–∞')) continue;
                
                const parts = line.split(';');
                if (parts.length >= 2) {
                    const date = parts[0].trim();
                    const shiftStr = parts[1].trim();
                    
                    if (date.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
                        const shiftTypes = shiftStr.split(',')
                            .map(s => parseInt(s.trim()))
                            .filter(s => s >= 1 && s <= 7);
                        
                        if (shiftTypes.length > 0) {
                            appData.schedule[date] = shiftTypes;
                            days++;
                            shifts += shiftTypes.length;
                        }
                    }
                }
            }
            
            if (days > 0) {
                alert(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${days} –¥–Ω–µ–π, ${shifts} –Ω–∞—Ä—è–¥–æ–≤`);
                showTab('results');
            } else {
                alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ');
            }
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        function generateSchedule() {
            if (appData.employees.length === 0) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤');
                return;
            }
            if (Object.keys(appData.schedule).length === 0) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ');
                return;
            }
            
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('generateBtn').disabled = true;
            
            setTimeout(() => {
                try {
                    // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                    const results = distributeShifts();
                    appData.results = results;
                    displayResults();
                    alert('‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ!');
                } catch (error) {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
                } finally {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('generateBtn').disabled = false;
                }
            }, 1000);
        }
        
        // –ü—Ä–æ—Å—Ç–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        function distributeShifts() {
            const assigned = [];
            const unassigned = [];
            const stats = {};
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            appData.employees.forEach(emp => {
                stats[emp.name] = { shifts: 0, slots: 15 };
            });
            
            // –°–æ–∑–¥–∞–µ–º –≤—Å–µ –Ω–∞—Ä—è–¥—ã
            const allShifts = [];
            for (const [date, types] of Object.entries(appData.schedule)) {
                for (const type of types) {
                    allShifts.push({ date, type });
                }
            }
            
            // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º
            for (const shift of allShifts) {
                let assignedTo = null;
                
                for (const emp of appData.employees) {
                    if (canAssign(emp, shift, stats[emp.name])) {
                        assignedTo = emp.name;
                        stats[emp.name].shifts++;
                        if (shift.type !== 7) stats[emp.name].slots--;
                        break;
                    }
                }
                
                if (assignedTo) {
                    assigned.push({
                        date: shift.date,
                        type: shift.type,
                        employee: assignedTo
                    });
                } else {
                    unassigned.push({
                        date: shift.date,
                        type: shift.type
                    });
                }
            }
            
            return {
                assigned: assigned,
                unassigned: unassigned,
                stats: stats,
                total: {
                    employees: appData.employees.length,
                    assigned: assigned.length,
                    unassigned: unassigned.length,
                    total: assigned.length + unassigned.length
                }
            };
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        function canAssign(emp, shift, stat) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—É—Å–∫–∞
            if (emp.vacationDays.includes(shift.date)) {
                return false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
            if (shift.type !== 7 && stat.slots <= 0) {
                return false;
            }
            
            return true;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function displayResults() {
            showStats();
            buildTable();
            showUnassigned();
            changeView(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∏–¥
        }
        
        // –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function showStats() {
            const container = document.getElementById('resultsContainer');
            const results = appData.results;
            
            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${results.total.total}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –Ω–∞—Ä—è–¥–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${results.total.assigned}</div>
                        <div class="stat-label">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${results.total.unassigned}</div>
                        <div class="stat-label">–ù–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${results.total.employees}</div>
                        <div class="stat-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
                    </div>
                </div>
                
                <h3>üìä –ü–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º:</h3>
            `;
            
            for (const [name, stat] of Object.entries(results.stats)) {
                html += `
                    <div class="result-item">
                        <strong>${name}</strong><br>
                        –ù–∞—Ä—è–¥–æ–≤: ${stat.shifts}<br>
                        –û—Å—Ç–∞–ª–æ—Å—å —Å–ª–æ—Ç–æ–≤: ${stat.slots}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        function buildTable() {
            const table = document.getElementById('calendarTable');
            const results = appData.results;
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞—Ç—ã
            const allDates = new Set();
            results.assigned.forEach(s => allDates.add(s.date));
            results.unassigned.forEach(s => allDates.add(s.date));
            const dates = Array.from(allDates).sort();
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            let html = '<tr><th class="employee-cell">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>';
            dates.forEach(date => {
                html += `<th>${date.split('.')[0]}</th>`;
            });
            html += '<th>–ò—Ç–æ–≥–æ</th></tr>';
            
            // –î–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            for (const emp of appData.employees) {
                let row = `<tr><td class="employee-cell">${emp.name}</td>`;
                let total = 0;
                
                for (const date of dates) {
                    let content = '';
                    let cls = '';
                    
                    if (emp.vacationDays.includes(date)) {
                        content = '–•';
                        cls = 'vacation-cell';
                    } else {
                        const shift = results.assigned.find(s => s.date === date && s.employee === emp.name);
                        if (shift) {
                            content = shift.type;
                            cls = 'shift-cell';
                            total++;
                        }
                    }
                    
                    row += `<td class="${cls}">${content}</td>`;
                }
                
                row += `<td><strong>${total}</strong></td></tr>`;
                html += row;
            }
            
            // –ù–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ
            if (results.unassigned.length > 0) {
                let row = '<tr><td class="employee-cell" style="background:#e74c3c;color:white;">–ù–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ</td>';
                let total = 0;
                
                for (const date of dates) {
                    const count = results.unassigned.filter(s => s.date === date).length;
                    if (count > 0) {
                        row += `<td class="unassigned-cell">${count}</td>`;
                        total += count;
                    } else {
                        row += '<td></td>';
                    }
                }
                
                row += `<td><strong>${total}</strong></td></tr>`;
                html += row;
            }
            
            table.innerHTML = html;
        }
        
        // –ü–æ–∫–∞–∑ –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö
        function showUnassigned() {
            const container = document.getElementById('unassignedContainer');
            const unassigned = appData.results.unassigned;
            
            if (unassigned.length === 0) {
                container.innerHTML = '<div class="result-item">–í—Å–µ –Ω–∞—Ä—è–¥—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã! üéâ</div>';
                return;
            }
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–∞–º
            const byDate = {};
            unassigned.forEach(shift => {
                if (!byDate[shift.date]) byDate[shift.date] = [];
                byDate[shift.date].push(shift.type);
            });
            
            let html = '<h3>‚ö†Ô∏è –ù–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –Ω–∞—Ä—è–¥—ã</h3>';
            
            for (const [date, types] of Object.entries(byDate)) {
                html += `
                    <div class="error-item">
                        <strong>${date}</strong><br>
                        –¢–∏–ø—ã –Ω–∞—Ä—è–¥–æ–≤: ${types.join(', ')}<br>
                        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${types.length}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // –°–º–µ–Ω–∞ –≤–∏–¥–∞
        function changeView() {
            const view = document.getElementById('viewType').value;
            
            document.getElementById('statsView').classList.add('hidden');
            document.getElementById('tableView').classList.add('hidden');
            document.getElementById('unassignedView').classList.add('hidden');
            
            document.getElementById(view + 'View').classList.remove('hidden');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            updateEmployeeFields();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
            if (tg?.initDataUnsafe?.user) {
                const user = tg.initDataUnsafe.user;
                document.querySelector('h1').textContent += ` - ${user.first_name || ''}`;
            }
        });
    </script>
</body>
</html>
